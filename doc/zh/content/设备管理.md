## 设备管理

### 1、设备初始化


根据设备ID初始化设备控制类

```java
ILightingDevice deviceInstance = TuyaLightingKitSdk.getInstance().newDeviceInstance(String devId);
```

参数说明：

| 参数  | 说明   |
| ----- | ------ |
| devId | 设备ID |

### 2、设备监听

**接口说明**

ILightingDevice 提供设备相关信息（ dp 数据、设备名称、设备在线状态和设备移除）的监听，会实时同步到这里。

```
ILightingDevice # registerDevListener(IDevListener listener)
```

**IDevListener**接口说明如下：

```
public interface IDevListener {

    /**
     * dp数据更新
     *
     * @param devId 设备 id
     * @param dpStr 设备发生变动的功能点，为 json 字符串，数据格式：{"101": true}
     */
    void onDpUpdate(String devId, String dpStr);

    /**
     * 设备移除回调
     *
     * @param devId 设备id
     */
    void onRemoved(String devId);

    /**
     * 设备上下线回调。如果设备断电或断网，服务端将会在3分钟后回调到此方法。
     *
     * @param devId  设备id
     * @param online 是否在线，在线为 true
     */
    void onStatusChanged(String devId, boolean online);

    /**
     * 网络状态发生变动时的回调
     *
     * @param devId  设备id
     *  @param status 网络状态是否可用，可用为 true
     */
    void onNetworkStatusChanged(String devId, boolean status);

    /**
     * 设备信息更新回调
     *
     * @param devId  设备 id
     */
    void onDevInfoUpdate(String devId);

}
```

**示例代码**

```
mDevice.registerDevListener(new IDevListener() {
    @Override
    public void onDpUpdate(String devId, String dpStr) {

    }
    @Override
    public void onRemoved(String devId) {

    }
    @Override
    public void onStatusChanged(String devId, boolean online) {

    }
    @Override
    public void onNetworkStatusChanged(String devId, boolean status) {

    }
    @Override
    public void onDevInfoUpdate(String devId) {

    }
});
```



### 3、取消设备监听

**接口说明**

当不需要监听设备时，注销设备监听器。

```
ILightingDevice # unRegisterDevListener()
```

**示例代码**

```
mDevice.unRegisterDevListener();
```

### 4、 设备控制

设备控制接口功能为向设备发送功能点，来改变设备状态或功能。

**接口说明**

设备控制支持三种通道控制，局域网控制，云端控制，和自动方式（如果局域网在线，先走局域网控制，局域网不在线，走云端控制）

- 局域网控制

  ```
  ILightingDevice # publishDps(dps,TYDevicePublishModeEnum.TYDevicePublishModeLocal, callback);
  ```

- 云端控制

  ```
  ILightingDevice #publishDps(dps, TYDevicePublishModeEnum.TYDevicePublishModeInternet, callback);
  ```

- 自动控制

  ```
  ILightingDevice # publishDps(dps, TYDevicePublishModeEnum.TYDevicePublishModeAuto, callback); 
  或 
  ILightingDevice # publishDps(dps, callback);
  ```

推荐使用```ILightingDevice # publishDps(dps,callback)```

**参数说明**

| 参数            | 说明                                        |
| --------------- | ------------------------------------------- |
| dps             | data points, 设备功能点，格式为 json 字符串 |
| publishModeEnum | 设备控制方式                                |
| callback        | 发送控制指令是否成功的回调                  |

**示例代码**

假设开灯的设备功能点是 101，那么开灯的控制代码如下所示：

```java
mDevice.publishDps("{\"101\": true}", new IResultCallback() {
    @Override
    public void onError(String code, String error) {
        Toast.makeText(mContext, "开灯失败", Toast.LENGTH_SHORT).show();
    }

    @Override
    public void onSuccess() {
        Toast.makeText(mContext, "开灯成功", Toast.LENGTH_SHORT).show();
    }
});
```

> **[warning] 注意事项**
>
> - 指令下发成功并不是指设备真正操作成功，只是意味着指令成功发送出去。操作成功会有 dp 数据信息上报上来 ，且通过 `IDevListener onDpUpdate` 接口返回。
> - command 命令字符串 是以 `Map<String,Object>`(dpId 和 dpValue 键值对)数据格式转成 json 字符串。
> - command 命令可以一次发送多个 dp 数据。

- **MESH设备控制**逻辑参考 [Mesh（SIG）设备控制](./Mesh(SIG)设备控制.md)

  

### 5、设备功能点说明

DeviceBean 类 dps 属性定义了设备的状态，称作数据点（ dp 点）或功能点。`dps` 字典里的每个 `key` 对应一个功能点的 `dpId`，`dpValue` 为该功能点的值。各自产品功能点定义参见[涂鸦开发者平台](https://iot.tuya.com/index)的产品功能。 功能点具体参见[功能点相关概念](https://docs.tuya.com/zh/iot/configure-in-platform/function-definition/custom-functions#功能点相关概念)

**指令格式**

发送控制指令按照以下格式： {"(dpId)":"(dpValue)"}

**示例代码**

```
//设置 dpId 为 101 的布尔型功能点示例 作用:开关打开 
dps = {"101": true};

//设置 dpId 为 102 的字符串型功能点示例 作用:设置 RGB 颜色为 ff5500
dps = {"102": "ff5500"};

//设置dpId为103的枚举型功能点示例 作用:设置档位为2档
dps = {"103": "2"};

//设置 dpId 为 104 的数值型功能点示例 用:设置温度为 20°
dps = {"104": 20};

//设置 dpId 为 105 的透传型( byte 数组)功能点示例 作用:透传红外数据为 1122
dps = {"105": "1122"};

//多个功能合并发送
dps = {"101": true, "102": "ff5500"};

mDevice.publishDps(dps, new IResultCallback() {
        @Override
        public void onError(String code, String error) {
        //错误码11001
        //有下面几种情况：
        //1、类型不对导致，例如，string 类型格式，发成 boolean 类型数据。
        //2、只读类型 dp 数据不能下发，参考 SchemaBean getMode "ro" 是只读类型。
        //3、raw 格式发送数据格式不是 16 进制字符串。
        }
        @Override
        public void onSuccess() {
        }
    });
```

> **[warning] 注意事项**
>
> - 控制命令的发送需要特别注意数据类型.
>
>   比如功能点的数据类型是数值型（ value ），那控制命令发送的应该是 `{"104": 25}` 而不是 `{"104": "25"}`
>
> - 透传类型传输的 byte 数组是 16 进制字符串格式并且必须是偶数位 比如正确的格式是: `{"105": "0110"}` 而不是 `{"105": "110"}`

- 设备信息查询

  **接口说明**

  查询单个 dp 数据。

  该接口并非同步接口，查询后的数据会通过 `IDevListener.onDpUpdate()` 接口回调。

  ```java
  mDevice.getDp(String dpId, IResultCallback callback);
  ```

  **示例代码**

  ```java
  mDevice.getDp(dpId, new IResultCallback() {
      @Override
      public void onError(String code, String error) {
      }
  
      @Override
      public void onSuccess() {
      }
  });
  ```

  > **[warning] 注意事项**
  >
  > 该接口主要是针对那些数据不主动去上报的 dp 点，例如倒计时信息查询。 常规查询 dp 数据值可以通过 DeviceBean 里面 getDps() 去获取。

### 6、修改设备名称

**接口说明**

设备重命名，支持多设备同步。

```java
//重命名
ILightingDevice # renameDevice(String name,IResultCallback callback);
```

**示例代码**

```java
mDevice.renameDevice("设备名称", new IResultCallback() {
    @Override
    public void onError(String code, String error) {
        //重命名失败
    }
    @Override
    public void onSuccess() {
        //重命名成功
    }
});
```

成功之后 ，`IDevListener.onDevInfoUpdate()` 会收到通知。

调用以下方法获取最新数据，然后刷新设备信息即可。

```java
TuyaCommercialLightingSdk.getDeviceManager().getDeviceBean(String devId);
```

### 7、移除设备

**接口说明**

用于从用户设备列表中移除设备

```java
ILightingDevice # removeDevice(IResultCallback callback);
```

**示例代码**

```java
mDevice.removeDevice(new IResultCallback() {
    @Override
    public void onError(String errorCode, String errorMsg) {
    }

    @Override
    public void onSuccess() {
    }
});
```

### 8、恢复出厂设置

**接口说明**

用于将设备重置，恢复到出厂状态，设备恢复出厂设置后，会重新进入待配网状态（快连模式），设备的相关数据会被清除掉。

```java
ILightingDevice # resetFactory(IResultCallback callback)
```

**示例代码**

```java
mDevice.resetFactory(new IResultCallback() {
    @Override
    public void onError(String errorCode, String errorMsg) {
    }

    @Override
    public void onSuccess() {
    }
});
```

### 9、回收设备资源

**接口说明**

应用或者 Activity 关闭时，可以调用此接口，回收设备占用的资源。

```java
ILightingDevice # onDestroy()
```

**示例代码**

```java
mDevice.onDestroy();
```

### 10、网关控制

网关本身也是个设备，如果要控制网关本身，可以参考之前的章节。

本节内容是控制网关下的子设备。

|       类名       | 说明                                                         |
| :--------------: | :----------------------------------------------------------- |
| ILightingGateway | 网关类封装了 Zigbee/SigMesh 网关的相关操作，包括控制、查询子设备，监听子设备状态等。 |

- 初始化网关

  **接口说明**

  创建网关对象，用来控制子设备。

  ```java
  TuyaCommercialLightingSdk.newGatewayInstance(String devId)
  ```

  **参数说明**

  | 参数  | 说明              |
  | ----- | ----------------- |
  | devId | 网关设备的设备 id |

- 获取子设备列表

  **接口说明**

  请求服务端接口，获取当前网关设备的子设备列表

  ```java
  void getSubDevList(ITuyaDataCallback<List<DeviceBean>> callback)
  ```

  **参数说明**

  该接口的参数为异步回调的 callback，callback 内容如下：

  ```java
  public interface ITuyaDataCallback<List<DeviceBean>> {
  
      void onSuccess(List<DeviceBean> result);
  
      void onError(String errorCode, String errorMessage);
  
  }
  ```

  将在成功后返回设备信息列表。

  **示例代码**

  ```java
  TuyaCommercialLightingSdk.newGatewayInstance(devId).getSubDevList(new ITuyaDataCallback<List<DeviceBean>>() {
      @Override
      public void onSuccess(List<DeviceBean> list) {
      }
  
      @Override
      public void onError(String errorCode, String errorMessage) {
  
      }
  });
  ```

- 注册子设备监听

  **接口说明**

  注册子设备状态监听，子设备状态的变更将回调到异步监听器中。

  ```java
  void registerSubDevListener(ISubDevListener listener);
  ```

  **参数说明**

  参数中的监听器接口内容如下：

  ```java
  public interface ISubDevListener {
  
      /**
       * 当设备dp点状态变更时的通知
       *
       * @param nodeId 子设备 nodeId，子设备 DeviceBean 中的 nodeId 字段
       * @param dpStr 子设备变更的功能点数据
       */
      void onSubDevDpUpdate(String nodeId, String dpStr);
  
      /**
       * 设备移除时的通知
       */
      void onSubDevRemoved(String devId);
  
      /**
       * 新增设备时的通知
       */
      void onSubDevAdded(String devId);
  
      /**
       * 子设备重命名时的通知
       */
      void onSubDevInfoUpdate(String devId);
  
      /**
       * 子设备在线 or 离线状态变更通知
       */
      void onSubDevStatusChanged(List<String> onlineNodeIds, List<String> offlineNodeIds);
  }
  ```

  **示例代码**

  ```java
  TuyaCommercialLightingSdk.newGatewayInstance(devId).registerSubDevListener(new ISubDevListener() {
      @Override
      public void onSubDevDpUpdate(String nodeId, String dpStr) {
  
      }
  
      @Override
      public void onSubDevRemoved(String devId) {
  
      }
  
      @Override
      public void onSubDevAdded(String devId) {
  
      }
  
      @Override
      public void onSubDevInfoUpdate(String devId) {
  
      }
  
      @Override
      public void onSubDevStatusChanged(List<String> onlines, List<String> offlines) {
  
      }
  });
  ```

- 销毁子设备监听

  **接口说明**

  不需要监听子设备时，注销子设备监听。

  ```java
  void unRegisterSubDevListener();
  ```

  **示例代码**

  ```java
  TuyaCommercialLightingSdk.newGatewayInstance(devId).unRegisterSubDevListener();
  ```

- 子设备单个控制

  **接口说明**

  向单个设备发送控制指令

  ```java
  void publishDps(String nodeId, String dps, IResultCallback callback)
  ```

  **参数说明**

  | 参数     | 说明                                        |
  | -------- | ------------------------------------------- |
  | nodeId   | 子设备节点 id，从子设备的 DeviceBean 中获取 |
  | dps      | 要控制的功能点列表，格式为 json 字符串      |
  | callback | 发送成功或失败的回调                        |

  **示例代码**

  ```java
  TuyaCommercialLightingSdk.newGatewayInstance(devId).publishDps(subDeviceBean.getNodeId(), "{\"101\": true}", new IResultCallback() {
      @Override
      public void onError(String code, String error) {
  
      }
  
      @Override
      public void onSuccess() {
  
      }
  });
  ```

- 子设备广播控制

  **接口说明**

  控制网关下所有子设备。

  ```
  void broadcastDps(String dps, IResultCallback callback)
  ```

  **参数说明**

  | 参数     | 说明                                   |
  | -------- | -------------------------------------- |
  | dps      | 要控制的功能点列表，格式为 json 字符串 |
  | callback | 发送成功或失败的回调                   |

  **示例代码**

  ```java
  TuyaCommercialLightingSdk.newGatewayInstance(devId).broadcastDps("{\"101\": true}", new IResultCallback() {
      @Override
      public void onError(String code, String error) {
  
      }
  
      @Override
      public void onSuccess() {
  
      }
  
  });
  ```